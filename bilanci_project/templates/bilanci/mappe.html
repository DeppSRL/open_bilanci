<!DOCTYPE html>
<html>
  <head>
    <title>Mappe OpenBilanci</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="http://www.openbilanci.it/static/img/favicon.ico" />
    
    <style>
      html, body, #map {
        height: 97%;
        padding: 0;
        margin: 0;
      }
      
      #cartocss {
          position: absolute;
          bottom: 200px;
          left: 20px;
      }
      .layer_selector {
          background: rgba(255,255,255,0.9);
          border-radius: 5px;
          padding: 0;
          border: 1px solid #999;
          width: 300px;
      }

      .layer_selector ul {
          padding: 0; margin: 0;
          list-style-type: none;
      }
      .layer_selector li {
          padding: 15px 30px;
          font-family: Helvetica, Arial;
          font-size: 13px;
          color: #444;
          cursor: pointer;
      }
      .layer_selector li:not(:last-child) {
          border-bottom: 1px solid #999;
      }
      .layer_selector li:hover {
          background-color: #F0F0F0;
          cursor: pointer;
      }
      .layer_selector li.sql_selected,
      .layer_selector li.cartocss_selected {
          background-color: #A6CEE3;
      }      
      #map .cartodb-legend {
          bottom: 90px;
          right: 30px;
      }
    </style>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
  </head>
  <body>
    <div id="map"></div>

    <div id="cartocss" class="layer_selector">
        <ul>
            <li data="spesa-personale-per-abitante" data-type="cartocss" class="cartocss_selected">
              Spesa per il personale, per abitante (€)
            </li>
            <li data="affidabilita-residui-attivi" data-type="cartocss">
              Affidabilità dei residui attivi (%)
            </li>
            <li data="autonomia-finanziaria" data-type="cartocss">
              Autonomia finanziaria (%)
            </li>
        </ul>
    </div>


    <!-- include cartodb.js library -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>

    
    <script>

    /**
     *
     * 
     *
     **/
    window.onload = function() {

        // the published map's json configuration URL (from CartoDB)
       
        // 2013
        // var vizjson = 'https://openpolis.cartodb.com/api/v2/viz/aa59eaa0-2a3c-11e5-b4f1-0e9d821ea90d/viz.json';

        // 2014
        var vizjson = 'https://openpolis.cartodb.com/api/v2/viz/e685fa2a-62ac-11e5-aa48-0e4fddd5de28/viz.json';

        // maps data attributes in layer_selector's li's to layer's 
        // order in CartoDB map editor
        // all layers should be set to visible in CartoDB editor
        var layers_map = {
          'spesa-personale-per-abitante': 2,
          'affidabilita-residui-attivi': 1,
          'autonomia-finanziaria': 0
        };
      

        /**
         * global function that switches the n-th layer within cartodb_layer on 
         * (and all other off)
         *
         * this function also (re)draws the legend, reading values from the
         * layer's objects 
         *
         * cartodb_layer - the layer in the map containing data sub layers
         * n             - the layer that has to be switched on; starting from 0
         **/
        function switchLayer(cartodb_layer, n){
          for (var i=0; i<cartodb_layer.getSubLayerCount(); i++) {
              if (i == n) {
                cartodb_layer.getSubLayer(i).show();
              } else {
                cartodb_layer.getSubLayer(i).hide();
              }
          }
          

          /**
           * extract colors array to be used in Legend.Density constructor
           * using CartoCSS extracted from currently selected layer
           * and parsed with a regular expression
           **/
          var css = cartodb_layer.getSubLayer(n).getCartoCSS();  // the CartoCSS string
          var r = /polygon-fill: (#.*);/g                        // extract all colors
          var colors = [];
          var color;
          while (color = r.exec(css)) {
            colors.push(color[1])
          }
          colors.shift();                                        // first color is removed, as is the general color
          colors.reverse();                                      // the array is reversed, to match the legend sorting


          /**
           * create a new instance of densityLegend, with 
           * title, colors and left and right values read from current layer
           **/
          var selected_layer = cartodb_layer.layers[n];
          var legend = new cdb.geo.ui.Legend.Choropleth({
           		title: selected_layer.legend.title + "<br/><span style=\"font-size: 9px;\">Dati forniti da <a href='http://www.openbilanci.it'>Openbilanci</a></span>",
           		show_title: true,
            	left: selected_layer.legend.items[0].value, 
            	right: selected_layer.legend.items[1].value, 
            	colors: colors
          });
          legend.model.set('template', '<div>CIAO</div>');
          
          $('#map.cartodb-legend').remove();                      // remove legend from DOM
          $('#map').append(legend.render().el);            // add new legend in DOM
        }
      
        /**
         * Create event handling for the layer selector
         **/
        function createSelector(cartodb_layer) {
            var cartocss = "";
            var $options = $(".layer_selector").find("li");
            
            $options.click(function(e) {
                var $li = $(e.target);
                var selected = $li.attr('data');

                $options.removeClass('cartocss_selected');        // change style for selected li
                $li.addClass('cartocss_selected');

                switchLayer(cartodb_layer, layers_map[selected]); // show only selected layer
            });
        }
        
       
        /**
         * map visualization
         **/
        cartodb.createVis('map', vizjson, {
          legends: false,
          center: [42.00, 12.00], // somewhere around Rome
          zoom: 6,
          scrollwheel: false,
          cartodb_logo: false
        })
        .done(function(vis, layers) {
            // find layer with cartodb sublayers
            var cartodb_layer;


            vis.map.set({
              minZoom: 6,
              maxZoom: 10
            });
            
            for (var l=0; l<layers.length; l++){
              if (layers[l].type == 'layergroup') {
                cartodb_layer = layers[l];
                break;
              }
            }                    
            createSelector(cartodb_layer);
            
            // switch default layer on
            switchLayer(cartodb_layer, layers_map['spesa-personale-per-abitante']);
            
            
        })
        .error(function(err) {
            console.log("An error occurred: " + err);
        });
                              
    }


    </script>

  </body>
</html>
