{%  extends "base.html" %}
{% load staticfiles %}
{% load humanize %}


{% block page_title %}
    Bilancio {{ tipo_bilancio }} per il Comune di {{ territorio }}, anno: {{ year }}
{% endblock %}



{% block content %}

    {% block city_and_name_data %}
        <div class="panel-heading">
            <a href="" class="pull-right share">Condividi <span class="glyphicon glyphicon-share"></span></a>
            <h1 class="panel-title">{{territorio.denominazione}}</h1>
            <p class="details">
                <span class="location">{{ territorio.prov }}, {{ territorio.regione|title }} </span>
                <span class="category"><span class="glyphicon glyphicon-record"></span>
                    {{ territorio.get_cluster_display }}, {{ comune_context.bil_popolazione_residente|intcomma }} abitanti</span>
            </p>
        </div>
    {% endblock %}

    <div class="panel-body">

        <div class="row">
            <div class="col-sm-12">
                {% block bilanci_navigation_menu %}
                    {% include 'bilanci/_navigation_menu.html' with active_voice='bilancio' %}
                {% endblock %}
                <h2 class="panel-title text-alt">{% block subtitle %}bilancio{% endblock %}</h2>
            </div>
        </div>

        <div class="row">
            <div id="content" class="col-sm-12">

                <div class="row timeline">
                    <div class="col-sm-12">
                        <div class="year-selector"></div>
                    </div>
                </div>

                <div id="results" class="row">
                    <div class="col-sm-12">
                        {% block bilanci_content %}
                            <!-- Nav Tabs -->
                            <ul class="nav nav-tabs nav-justified">
                                <li class="active"><a href="#composizione" data-toggle="tab">COMPOSIZIONE</a></li>
                                <li><a href="#analisi-e-trend" data-toggle="tab">ANALISI E TREND</a></li>
                            </ul>

                            <hr class="no-border">

                            <!-- Tab panes -->
                            <div class="tab-content">
                                <div class="tab-pane fade in active" id="composizione">
                                    {% include 'bilanci/_composition_widget.html' with bilancio_type='complessivo' %}
                                </div>

                                <div class="tab-pane fade in" id="analisi-e-trend">
                                    <figure class="stripe thumbnail">
                                        <img src="http://cambelt.co/200x600/Analisi+e+trend" class="img-responsive" alt="Analisi e trend">
                                    </figure>
                                </div>
                            </div>
                        {% endblock %}
                    </div>
                </div>
            </div>
        </div>

    </div>


{% endblock content %}

{% block extra_js %}
    <!-- visup js -->
    <script src="{% static 'scripts/visup/all.js' %}" type="text/javascript"></script>
    <script src="{% static 'scripts/linechart_utils.js' %}" type="text/javascript"></script>
    <script src="{% static 'scripts/yr_selector_utils.js' %}" type="text/javascript"></script>

    <!-- Raphael -->
    <script src="{% static 'scripts/vendor/raphael/raphael.js' %}"></script>
    <script src="{% static 'scripts/vendor/g.raphael/g.raphael.js' %}"></script>
    <script src="{% static 'scripts/vendor/g.raphael/g.pie.js' %}"></script>


    <!-- Initialization for year/budget type selector and linecharts -->
    <script type="text/javascript">
        $(document).ready(function(){

               /**
                * initialize year selectors
                **/
                init_selector(
                        {{ selector_default_year }},
                        {{ selected_year }},
                        true,
                        '{{ selected_bilancio_type }}',
                        "{% url 'bilanci-spese' slug=territorio.slug %}?year={{ selected_year }}&type={{ selected_bilancio_type }}"
                );



               /**
                * set handlers for trend charts
                **/
                $( "#results" ).find( '.trend-chart-toggle' ).on( 'click', function( e ){
                    e.preventDefault();

                    var btn = $( this );
                    var chart_container = $('tr#trend-chart-container-' + btn.attr('id').split('-').pop());
                    var chart_td = chart_container.find('td');
                    var voce_slug = btn.attr('href').substring(1);

                    if (chart_td.find('div').length == 0) {
                        chart_td.append($("<div>").addClass("trend-chart"));
                        chart = $("#" + chart_container.attr('id') + " .trend-chart");
                        var linechart = visup.linechart("#" + chart_container.attr('id') + " .trend-chart");
                        linechart.options({
                                timeline: {
                                    visible: false
                                },
                                linechart: {
                                    height: 150,
                                    start: 2003,
                                    end: 2014,
                                    circleRadius: 9,
                                    axisUnit: "MILIONI",
                                    tooltipUnit: "MLN",
                                    format: "%Y",
                                    visible: true
                                },
                                legend: {
                                    rowItems: 2
                                }
                            });
                        d3.json(
                            "/incarichi_voce/{{ territorio.op_id }}/" + voce_slug,
                            function (i) {
                                linechart.data(i);
                                linechart.resize();
                            }
                        );
                    }

                    if (chart_container.hasClass('hidden')) {
                        chart_container.removeClass( 'hidden' );
                    } else {
                        chart_container.addClass( 'hidden' );
                    }

                    return false;

                });

                init_linechart();
                feed_linechart();

            });
    </script>

    {% block extra_js_inner %}
        {# block for extra js activity needed for children templates   #}
    {% endblock %}

{% endblock %}

{% block extra_css %}
    {#    <!-- visup css-->#}
    <link href='http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    <link href="{% static 'css/visup/visup-style.css' %}" media="screen" rel="stylesheet" type="text/css" />
    {#    <!-- / visup css-->#}
{% endblock %}