{%  extends "bilanci/bilancio_base.html" %}
{% load staticfiles %}
{% load section_title %}
{% load section_values_type %}
{% load popover_info %}

{% block page_title %}
    {{ selected_section|title }} del bilancio {{ selected_bilancio_type }} per il Comune di {{ territorio }}, anno {{ year }}
{% endblock %}


{% block bilanci_content %}
    <!-- Nav Tabs -->
    <ul class="nav nav-tabs nav-justified">
        <li class="active"><a href="#composizione" data-toggle="tab">COMPOSIZIONE DELLE {{ selected_section|upper }} E PRIORIT&Agrave;</a></li>
        <li ><a id="andamento-tempo-dettaglio" href="#dettaglio" data-toggle="tab">ANDAMENTO NEL TEMPO E DETTAGLIO</a></li>
    </ul>

    <hr class="no-border">

    <!-- Tab panes -->
    <div class="tab-content">
        <div class="tab-pane fade in active" id="composizione">
            <div class="row" style="margin-top: 15px;">
                <div class="col-md-12">
                    {% if tipo_bilancio == "consuntivo" %}
                        {% section_values_type cas_com_type=cas_com_type values_type=values_type tooltip=True %}
                    {% else %}
                        {% section_values_type values_type=values_type tooltip=True %}
                    {% endif %}
                    <h3 style="margin-top: 0; font-size: 18px;">
                        {% section_title bold_text="BILANCIO" main_bilancio_type=tipo_bilancio main_bilancio_year=selected_year comparison_bilancio_type=comparison_bilancio_type comparison_bilancio_year=comparison_bilancio_year %}
                    </h3>
                </div>
            </div>

            <div class="row" >
                <div class="col-md-12">
                Qual è la politica di chi amministra il Comune? Quali sono le sue priorità?<br/>
                Fai click sulla bolla per vedere la composizione delle {{ selected_section|title }} e come si distribuiscono
                <span style="font-weight: bold; color:#7d8e17">GLI AUMENTI</span> e in alto,
                e <span style="font-weight: bold; color:#9b2d1b">LE RIDUZIONI</span> e in basso. {% popover_info 'widget-bilancio' %}
                </div>
            </div>
            {#            composition widget#}
            <iframe class="composition-widget" frameborder='0' style="width: 100%;height: 722px;"
                src="{% url 'composition-widget' widget_type=selected_section territorio_slug=territorio.slug bilancio_year=selected_year bilancio_type=tipo_bilancio %}?values_type={{ values_type }}&cas_com_type={{ cas_com_type }}"></iframe>
        </div>

        <div class="tab-pane fade in " id="dettaglio">

            <div class="row">
                <div class="col-md-7 section_title" style="">
                    <h3>{% section_title bold_text="BILANCI" main_bilancio_type=bilancio_type_title %}</h3>
                </div>
                <div class="col-md-5 section_title" style="">
                    {% if tipo_bilancio == "consuntivo" %}
                        {% section_values_type cas_com_type=cas_com_type values_type=values_type tooltip=True per_capita=True%}
                    {% else %}
                        {% section_values_type values_type=values_type tooltip=True per_capita=True%}
                    {% endif %}
                </div>
            </div>


            {% include 'commons/_lines_chart_over_the_years.html' %}

            <hr class="no-border">

            {% block content_header %}

            {% endblock %}


            {% block bilanci_accordion %}
                <!-- Default panel contents -->

                <div>ACCORDION HERE</div>
            {%  endblock bilanci_accordion %}
        </div>
    </div>
{% endblock %}

{% block extra_js_inner %}

    <!-- Raphael -->
    <script src="{% static 'scripts/vendor/raphael/raphael.js' %}"></script>
    <script src="{% static 'scripts/vendor/g.raphael/g.raphael.js' %}"></script>
    <script src="{% static 'scripts/vendor/g.raphael/g.pie.js' %}"></script>


   <script type="text/javascript">

    $(document).ready(function(){

        /*
        * initialize year selectors
        * */
        var selector_init_obj ={
            'selector_default_year':{{ selector_default_year }},
            'selected_year':{{ selected_year }},
            'visible_buttons': true,
            'selected_bilancio_type': '{{ selected_bilancio_type }}',
            'start_year': {{ timeline_start_year }},
            'end_year': {{ timeline_end_year }},
            'reference_url': ''
        };

        {% if selected_section == 'entrate' %}
            selector_init_obj['reference_url']="{% url 'bilanci-entrate' slug=territorio.slug %}?year={{ selected_year }}&type={{ selected_bilancio_type }}";
        {% else %}
            selector_init_obj['reference_url']="{% url 'bilanci-spese' slug=territorio.slug %}?year={{ selected_year }}&type={{ selected_bilancio_type }}";
        {% endif %}

        init_selector(selector_init_obj);

        /**
        * set handlers for secondary trend charts (the ones in the accordion)
        **/
        $('#results').find('.chart-container').on('shown.bs.collapse', { timeline_start_year:{{ timeline_start_year }},timeline_end_year:{{ timeline_end_year }} }, init_secondary_linechart);

        $('a[data-toggle="tab"]').on("shown.bs.tab",function(){
            {# fixes graph size on tab switch   #}
            linechart.resize();
        });
        init_main_linechart({{ timeline_start_year }},{{ timeline_end_year }},"EURO","EURO");
        feed_main_linechart();


    });


    function feed_main_linechart(){
        d3.json("{% url 'incarichi-voce-json' territorio_opid=territorio_opid voce_slug=bilancio_rootnode %}" +
                "?values_type={{ values_type }}",
                function (i) {
            linechart.data(i);
            linechart.year({{ selected_year }});
        });

    }

   function feed_secondary_linechart(voce_slug){
       {%  comment %}

         if voce_slug is from spese funzioni (preventivo / consuntivo) then the graph to be visualized
         is the graph relative to  spese somma funzioni.
         example: consuntivo-spese-impegni-spese-correnti-funzioni-amministrazione -> consuntivo-spese-impegni-spese-somma-funzioni-amministrazione

       {% endcomment %}

        if (window.location.search.indexOf("fun_int_view") == -1 ||
            window.location.search.indexOf("fun_int_view=funzioni") != -1) {
            if (voce_slug.indexOf("preventivo-spese-spese-correnti") == 0 ||
                    voce_slug.indexOf("consuntivo-spese-cassa-spese-correnti") == 0 ||
                    voce_slug.indexOf("consuntivo-spese-impegni-spese-correnti") == 0 ){

                    if(voce_slug == "preventivo-spese-spese-correnti" ||
                            voce_slug == "consuntivo-spese-cassa-spese-correnti" ||
                            voce_slug == "consuntivo-spese-impegni-spese-correnti" ){

                        voce_slug=voce_slug.replace("spese-correnti", "spese-somma-funzioni");
                    }
                    else{
                        voce_slug=voce_slug.replace("spese-correnti", "spese-somma");
                        }
            }
        }

        d3.json(
            "/incarichi_voce/{{ territorio.op_id }}/" + voce_slug +
                "?values_type={{ values_type }}",
            function (i) {
                secondary_linechart.data(i);
                secondary_linechart.resize();
                secondary_linechart.year({{ selected_year }});
            }
        );
    }


    </script>

{% endblock %}
