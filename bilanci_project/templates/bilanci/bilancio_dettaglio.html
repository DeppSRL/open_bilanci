{%  extends "bilanci/bilancio_overview.html" %}
{% load staticfiles %}
{% load section_title %}
{% load section_values_type %}
{% load voice_values %}
{% load popover_info %}

{% block bilancio_description %}

    {#    description #}
    {% section_title bold_text="DETTAGLIO" main_bilancio_type=tipo_bilancio main_bilancio_year=selected_year  %}

    {# selettore funzioni / interventi    #}
    {% if selected_section == 'spese' %}
        <span class="fun-int">
            <a href="{% if fun_int_current_view != 'funzioni' %}{{ fun_int_switch.url }}{% else %}#{% endif %}">
                <span class="label label-blu {% if fun_int_current_view == 'funzioni' %}active{% endif %}">Vista per Funzioni</span>
            </a>
            <a href="{% if fun_int_current_view != 'interventi' %}{{ fun_int_switch.url }}{% else %}#{% endif %}">
                <span class="label label-blu {% if fun_int_current_view == 'interventi' %}active{% endif %}">Vista per Interventi</span>
            </a>
        </span>
    {% endif %}

{% endblock %}


{% block bilanci_content %}

    {#  totale generale   #}
    <div class="panel-group panel-tree totale-generale">
        <div class="panel">
            <div class="panel-heading">
                <div class="row">
                    <div class="col-sm-6 entry" id="consuntivo-entrate-cassa">
                        <h2>TOTALE {{ selected_section|upper }}</h2>
                    </div>

                    <div class="col-sm-3 actions">
                        {% voice_values bilancio_rootnode.slug budget_values %}
                    </div>

                    <div class="col-sm-2 col-md-offset-1">
                           <a href="#{{ bilancio_rootnode.slug }}"  class="pull-right btn btn-blu nolenght trend-chart-toggle"  data-toggle="collapse"
                              id="trend-chart-toggle-{{ bilancio_rootnode.pk }}" data-target="#trend-chart-container-{{ bilancio_rootnode.pk }}">
                               Grafico <i class="icon sprite-grafico"></i><i class="fa fa-angle-down pull-right"></i>
                           </a>
                    </div>
                </div>
                {# trend chart container               #}
                <div id="trend-chart-container-{{ bilancio_rootnode.pk }}" class="collapse chart-container">
                    <div class="row details">
                        <div class="col-md-12">
                            {#  secondary graph title #}
                            <div class="row">
                                <div class="col-md-8 section_title" style="">
                                    {% section_title bold_text="BILANCI" main_bilancio_type=bilancio_type_title main_bilancio_year=year  %}
                                </div>
                                <div class="col-md-4 section_title" style="">
                                    <div class="cas_com_box pull-right">
                                        {% section_values_type cas_com_type=cas_com_type values_type=values_type tooltip=True per_capita=True %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        {#  secondary graph  #}
                        <div class="col-md-12 graph-box"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {#    accordion #}

    {%  if selected_section == 'entrate' %}

        {% include 'bilanci/_accordion_entrate.html' %}

    {% else %}

        {% if fun_int_current_view == 'interventi' %}
            {% include 'bilanci/_accordion_spese_interventi.html' %}
        {% else %}
            {% include 'bilanci/_accordion_spese_funzioni.html' %}
        {% endif %}

    {% endif %}

{% endblock %}

{% block extra_js_dettaglio %}


    <!-- Raphael -->
    <script src="{% static 'scripts/vendor/raphael/raphael.js' %}"></script>
    <script src="{% static 'scripts/vendor/g.raphael/g.raphael.js' %}"></script>
    <script src="{% static 'scripts/vendor/g.raphael/g.pie.js' %}"></script>

    <script type="text/javascript">

       function feed_secondary_linechart(voce_slug){
           {%  comment %}

             if voce_slug is from spese funzioni (preventivo / consuntivo) then the graph to be visualized
             is the graph relative to  spese somma funzioni.
             example: consuntivo-spese-impegni-spese-correnti-funzioni-amministrazione -> consuntivo-spese-impegni-spese-somma-funzioni-amministrazione

           {% endcomment %}

            if (window.location.search.indexOf("fun_int_view") == -1 ||
                window.location.search.indexOf("fun_int_view=funzioni") != -1) {
                if (voce_slug.indexOf("preventivo-spese-spese-correnti") == 0 ||
                        voce_slug.indexOf("consuntivo-spese-cassa-spese-correnti") == 0 ||
                        voce_slug.indexOf("consuntivo-spese-impegni-spese-correnti") == 0 ){

                        if(voce_slug == "preventivo-spese-spese-correnti" ||
                                voce_slug == "consuntivo-spese-cassa-spese-correnti" ||
                                voce_slug == "consuntivo-spese-impegni-spese-correnti" ){

                            voce_slug=voce_slug.replace("spese-correnti", "spese-somma-funzioni");
                        }
                        else{
                            voce_slug=voce_slug.replace("spese-correnti", "spese-somma");
                            }
                }
            }

            d3.json(
                "/incarichi_voce/{{ territorio.op_id }}/" + voce_slug +
                    "?values_type={{ values_type }}",
                function (i) {
                    secondary_linechart.data(i);
                    secondary_linechart.resize();
                    secondary_linechart.year({{ selected_year }});
                }
            );
        }

       {# prevents the browser to add a #slug-voce to the window.location      #}
       function avoidAnchorBehaviour(event){
           event.preventDefault();
       }

       $(document).ready(function(){

            /**
            * set handlers for secondary trend charts (the ones in the accordion)
            **/
            $('#content').find('.chart-container').on('shown.bs.collapse',
                                                      { timeline_start_year:{{ timeline_start_year }},timeline_end_year:{{ timeline_end_year }} }, init_secondary_linechart);

            $('#content').find('.chart-container').on('hidden.bs.collapse', close_secondary_linechart);

            $('#content').find('.trend-chart-toggle').on('click', avoidAnchorBehaviour);

            var lhash = location.hash;

            // if a voce slug is in the hash then scroll to that voce in the accordion
            if(lhash != ''){
                var startElement = lhash.replace("spese-somma-funzioni","spese-correnti-funzioni");
                var targetElement =startElement.replace("#","#heading-");
                autoOpenNestedAccordion(targetElement);
                goToIdByScroll(targetElement);
            }


        });

    </script>

{% endblock %}